<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>V√©rification de mot de passe</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #eef1f5;
            font-family: 'Ubuntu', sans-serif;
        }
        .box {
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            max-width: 500px;
            margin: 50px auto;
        }
        .password-toggle {
            position: absolute;
            right: 15px;
            top: 38px;
            cursor: pointer;
        }
        .position-relative {
            position: relative;
        }
        h2 {
            text-align: center;
            margin-bottom: 30px;
        }
    </style>
</head>
<body>
    {% include 'navbar.html' %}

    <div class="container">
        <div class="box">
            <h2>üîê V√©rifie si ton mot de passe est s√©curis√©</h2>
            <form method="POST" id="passwordForm">
                <div class="mb-3 position-relative">
                    <label for="password" class="form-label">Mot de passe :</label>
                    <input type="password" name="password" id="password" class="form-control" oninput="checkStrength()">
                    <span class="password-toggle" onclick="togglePassword()">üëÅÔ∏è</span>
                </div>

                <div class="mb-3">
                    <div class="progress">
                        <div id="passwordStrength" class="progress-bar" role="progressbar" style="width: 0%">Force</div>
                    </div>
                </div>

                <div class="d-grid gap-2">
                    <button type="button" onclick="displayVerificationResult()" class="btn btn-primary">V√©rifier</button>
                    <button type="button" onclick="generateAndDisplayPassword(document.getElementById('password').value)" class="btn btn-secondary">G√©n√©rer un mot de passe fort</button>
                </div>
            </form>

            <div class="mt-4 alert alert-warning" id="missingCriteriaContainer" style="display:none;">
                <strong>Votre mot de passe manque :</strong><br>
                <span id="missingCriteria"></span>
            </div>

            <div class="mt-4 alert alert-info" id="generatedPasswordContainer" style="display:none;">
                <strong>Mot de passe sugg√©r√© :</strong><br>
                <span id="generatedPassword"></span>
                <button class="btn btn-success btn-sm" onclick="copyPassword()">Copier</button>
            </div>

            {% if result %}
                <div class="mt-4 alert {{ 'alert-success' if 'fort' in result else 'alert-danger' }}" id="backendResultContainer">
                    <strong>R√©sultat du serveur :</strong><br>
                    {{ result }}
                </div>
            {% endif %}
        </div>
    </div>

    <script>
        function togglePassword() {
            const passwordField = document.getElementById("password");
            passwordField.type = passwordField.type === "password" ? "text" : "password";
        }

        function checkStrength() {
            const password = document.getElementById("password").value;
            const bar = document.getElementById("passwordStrength");
            const generatedPasswordContainer = document.getElementById("generatedPasswordContainer");
            let strength = 0;
            let missing = [];

            const hasLower = /[a-z]/.test(password);
            const hasUpper = /[A-Z]/.test(password);
            const hasNumber = /[0-9]/.test(password);
            const hasSpecial = /[^A-Za-z0-9]/.test(password);
            const hasLength = password.length >= 8;

            if (hasLower) strength += 20; else if (password.length > 0) missing.push("une minuscule");
            if (hasUpper) strength += 20; else if (password.length > 0) missing.push("une majuscule");
            if (hasNumber) strength += 20; else if (password.length > 0) missing.push("un chiffre");
            if (hasSpecial) strength += 20; else if (password.length > 0) missing.push("un caract√®re sp√©cial");
            if (hasLength) strength += 20; else if (password.length > 0) missing.push("8 caract√®res ou plus");

            bar.style.width = strength + "%";
            bar.classList.remove("bg-danger", "bg-warning", "bg-success");
            document.getElementById("missingCriteriaContainer").style.display = "none";
            generatedPasswordContainer.style.display = "none";

            if (password.length === 0) {
                bar.style.width = "0%";
                bar.textContent = "Force";
            } else if (strength < 40) {
                bar.classList.add("bg-danger");
                bar.textContent = "Faible";
                document.getElementById("generatedPassword").textContent = generateStrongPasswordFromBase(password);
                generatedPasswordContainer.style.display = "block";
            } else if (strength < 80) {
                bar.classList.add("bg-warning");
                bar.textContent = "Moyen";
                document.getElementById("generatedPassword").textContent = generateStrongPasswordFromBase(password);
                generatedPasswordContainer.style.display = "block";
            } else if (strength === 100 && hasLower && hasUpper && hasNumber && hasSpecial && hasLength) {
                bar.classList.add("bg-success");
                bar.textContent = "Fort";
            } else if (strength >= 80) {
                bar.classList.add("bg-warning"); // Consider anything 80 or above (but not fully 100) as medium
                bar.textContent = "Moyen";
                document.getElementById("generatedPassword").textContent = generateStrongPasswordFromBase(password);
                generatedPasswordContainer.style.display = "block";
            }
        }


        
        function displayVerificationResult() {
            const password = document.getElementById("password").value;
            let missing = [];
            if (password.length < 8) missing.push("8 caract√®res ou plus");
            if (!/[a-z]/.test(password)) missing.push("une minuscule");
            if (!/[A-Z]/.test(password)) missing.push("une majuscule");
            if (!/[0-9]/.test(password)) missing.push("un chiffre");
            if (!/[^A-Za-z0-9]/.test(password)) missing.push("un caract√®re sp√©cial");

            const missingCriteriaContainer = document.getElementById("missingCriteriaContainer");
            const missingCriteriaElement = document.getElementById("missingCriteria");

            if (missing.length > 0) {
                missingCriteriaElement.textContent = missing.join(", ");
                missingCriteriaContainer.style.display = "block";
            } else {
                missingCriteriaContainer.style.display = "block";
                missingCriteriaElement.textContent = "Votre mot de passe r√©pond √† tous les crit√®res de base.";
            }
        }

        function generateAndDisplayPassword(base) {
            const generatedPassword = generateStrongPasswordFromBase(base);
            document.getElementById("generatedPassword").textContent = generatedPassword;
            document.getElementById("generatedPasswordContainer").style.display = "block";
            document.getElementById("passwordStrength").style.width = "100%";
            document.getElementById("passwordStrength").classList.remove("bg-danger", "bg-warning");
            document.getElementById("passwordStrength").classList.add("bg-success");
            document.getElementById("passwordStrength").textContent = "Fort";
            document.getElementById("missingCriteriaContainer").style.display = "none"; // Hide missing criteria
        }

        function generateStrongPasswordFromBase(basePassword) {
            const required = [];
            const allChars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*(),.?\":{}|<>";
            let tempPassword = basePassword;

            if (!/[A-Z]/.test(tempPassword)) {
                required.push(randomChoice("ABCDEFGHIJKLMNOPQRSTUVWXYZ"));
            }
            if (!/[a-z]/.test(tempPassword)) {
                required.push(randomChoice("abcdefghijklmnopqrstuvwxyz"));
            }
            if (!/[0-9]/.test(tempPassword)) {
                required.push(randomChoice("0123456789"));
            }
            if (!/[^A-Za-z0-9]/.test(tempPassword)) {
                required.push(randomChoice("!@#$%^&*(),.?\":{}|<>"));
            }

            while (tempPassword.length + required.length < 12) {
                required.push(randomChoice(allChars));
            }

            return shuffle(tempPassword + required.join(''));
        }

        function randomChoice(str) {
            return str.charAt(Math.floor(Math.random() * str.length));
        }

        function shuffle(str) {
            const arr = str.split('');
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr.join('');
        }

        function copyPassword() {
            const passwordText = document.getElementById("generatedPassword").textContent;
            navigator.clipboard.writeText(passwordText).then(function() {
                alert("Mot de passe copi√© !");
            }, function(err) {
                alert("Erreur lors de la copie : " + err);
            });
        }

        document.addEventListener("DOMContentLoaded", function() {
            document.getElementById("password").addEventListener("input", checkStrength);
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>